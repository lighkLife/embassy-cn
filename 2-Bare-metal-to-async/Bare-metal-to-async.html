<!doctype html>
<html class="no-js" lang="zh_CN">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="next" title="执行器 Executor" href="../3-Executor/index.html" /><link rel="prev" title="在裸机上异步" href="index.html" />

    <meta name="generator" content="sphinx-4.3.2, furo 2022.06.21"/>
        <title>From bare metal to async Rust - embassy-cn 0.1.0 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">embassy-cn 0.1.0 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">embassy-cn 0.1.0 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=搜索 name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../0-Embassy/Embassy.html">Embassy</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../1-Getting-started/index.html">快速开始</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../1-Getting-started/Basic-application.html">A basic Embassy application</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">在裸机上异步</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">From bare metal to async Rust</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../3-Executor/index.html">执行器 Executor</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../3-Executor/executor.html">执行器 Executor</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../4-HAL/index.html">硬件抽象层 HAL</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../4-HAL/nRF.html">Embassy nRF HAL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4-HAL/STM32.html">Embassy STM32 HAL</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../5-Bootloader/index.html">引导程序</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../5-Bootloader/Bootloader.html">引导程序</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../6-Examples/index.html">例子</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../6-Examples/Examples.html">Examples</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../7-Developer/index.html">开发者文档</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../7-Developer/Developer-STM32.html">Developer Documentation: STM32</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <div class="section" id="from-bare-metal-to-async-rust">
<h1>From bare metal to async Rust<a class="headerlink" href="#from-bare-metal-to-async-rust" title="永久链接至标题">#</a></h1>
<p>If you’re new to Embassy, it can be overwhelming to grasp all the terminology and concepts. This guide aims to clarify the different layers in Embassy, which problem each layer solves for the application writer.</p>
<p>This guide uses the STM32 IOT01A board, but should be easy to translate to any STM32 chip. For nRF, the PAC itself is not maintained within the Embassy project, but the concepts and the layers are similar.</p>
<p>The application we’ll write is a simple ‘push button, blink led’ application, which is great for illustrating input and output handling for each of the examples we’ll go through. We’ll start at the Peripheral Access Crate (PAC) example and end at the async example.</p>
<div class="section" id="pac-version">
<h2>PAC version<a class="headerlink" href="#pac-version" title="永久链接至标题">#</a></h2>
<p>The PAC is the lowest API for accessing peripherals and registers, if you don’t count reading/writing directly to memory addresses. It provides distinct types to make accessing peripheral registers easier, but it does not prevent you from writing unsafe code.</p>
<p>Writing an application using the PAC directly is therefore not recommended, but if the functionality you want to use is not exposed in the upper layers, that’s what you need to use.</p>
<p>The blinky app using PAC is shown below:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#![no_std]</span>
<span class="cp">#![no_main]</span>

<span class="k">use</span><span class="w"> </span><span class="n">pac</span>::<span class="n">gpio</span>::<span class="n">vals</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="p">{</span><span class="n">defmt_rtt</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">panic_probe</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">stm32_metapac</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">pac</span><span class="p">};</span>

<span class="cp">#[cortex_m_rt::entry]</span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Enable GPIO clock</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rcc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pac</span>::<span class="n">RCC</span><span class="p">;</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">rcc</span><span class="p">.</span><span class="n">ahb2enr</span><span class="p">().</span><span class="n">modify</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">w</span><span class="p">.</span><span class="n">set_gpioben</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="n">w</span><span class="p">.</span><span class="n">set_gpiocen</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="n">rcc</span><span class="p">.</span><span class="n">ahb2rstr</span><span class="p">().</span><span class="n">modify</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">w</span><span class="p">.</span><span class="n">set_gpiobrst</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="n">w</span><span class="p">.</span><span class="n">set_gpiocrst</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="n">w</span><span class="p">.</span><span class="n">set_gpiobrst</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">            </span><span class="n">w</span><span class="p">.</span><span class="n">set_gpiocrst</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Setup button</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">gpioc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pac</span>::<span class="n">GPIOC</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">BUTTON_PIN</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">gpioc</span><span class="p">.</span><span class="n">pupdr</span><span class="p">().</span><span class="n">modify</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">set_pupdr</span><span class="p">(</span><span class="n">BUTTON_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">vals</span>::<span class="n">Pupdr</span>::<span class="n">PULLUP</span><span class="p">));</span>
<span class="w">        </span><span class="n">gpioc</span><span class="p">.</span><span class="n">otyper</span><span class="p">().</span><span class="n">modify</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">set_ot</span><span class="p">(</span><span class="n">BUTTON_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">vals</span>::<span class="n">Ot</span>::<span class="n">PUSHPULL</span><span class="p">));</span>
<span class="w">        </span><span class="n">gpioc</span><span class="p">.</span><span class="n">moder</span><span class="p">().</span><span class="n">modify</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">set_moder</span><span class="p">(</span><span class="n">BUTTON_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">vals</span>::<span class="n">Moder</span>::<span class="n">INPUT</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Setup LED</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">gpiob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pac</span>::<span class="n">GPIOB</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">LED_PIN</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">14</span><span class="p">;</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">gpiob</span><span class="p">.</span><span class="n">pupdr</span><span class="p">().</span><span class="n">modify</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">set_pupdr</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">vals</span>::<span class="n">Pupdr</span>::<span class="n">FLOATING</span><span class="p">));</span>
<span class="w">        </span><span class="n">gpiob</span><span class="p">.</span><span class="n">otyper</span><span class="p">().</span><span class="n">modify</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">set_ot</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">vals</span>::<span class="n">Ot</span>::<span class="n">PUSHPULL</span><span class="p">));</span>
<span class="w">        </span><span class="n">gpiob</span><span class="p">.</span><span class="n">moder</span><span class="p">().</span><span class="n">modify</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">set_moder</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">vals</span>::<span class="n">Moder</span>::<span class="n">OUTPUT</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Main loop</span>
<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">gpioc</span><span class="p">.</span><span class="n">idr</span><span class="p">().</span><span class="n">read</span><span class="p">().</span><span class="n">idr</span><span class="p">(</span><span class="n">BUTTON_PIN</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">vals</span>::<span class="n">Idr</span>::<span class="n">LOW</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">gpiob</span><span class="p">.</span><span class="n">bsrr</span><span class="p">().</span><span class="n">write</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">set_bs</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">gpiob</span><span class="p">.</span><span class="n">bsrr</span><span class="p">().</span><span class="n">write</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">set_br</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you can see, a lot of code is needed to enable the peripheral clocks and to configure the input pins and the output pins of the application.</p>
<p>Another downside of this application is that it is busy-looping while polling the button state. This prevents the microcontroller from utilizing any sleep mode to save power.</p>
</div>
<div class="section" id="hal-version">
<h2>HAL version<a class="headerlink" href="#hal-version" title="永久链接至标题">#</a></h2>
<p>To simplify our application, we can use the HAL instead. The HAL exposes higher level APIs that handle details such as:</p>
<ul class="simple">
<li><p>Automatically enabling the peripheral clock when you’re using the peripheral</p></li>
<li><p>Deriving and applying register configuration from higher level types</p></li>
<li><p>Implementing the embedded-hal traits to make peripherals useful in third party drivers</p></li>
</ul>
<p>The HAL example is shown below:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#![no_std]</span>
<span class="cp">#![no_main]</span>

<span class="k">use</span><span class="w"> </span><span class="n">cortex_m_rt</span>::<span class="n">entry</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">embassy_stm32</span>::<span class="n">gpio</span>::<span class="p">{</span><span class="n">Input</span><span class="p">,</span><span class="w"> </span><span class="n">Level</span><span class="p">,</span><span class="w"> </span><span class="n">Output</span><span class="p">,</span><span class="w"> </span><span class="n">Pull</span><span class="p">,</span><span class="w"> </span><span class="n">Speed</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="p">{</span><span class="n">defmt_rtt</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">panic_probe</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">};</span>

<span class="cp">#[entry]</span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">embassy_stm32</span>::<span class="n">init</span><span class="p">(</span><span class="nb">Default</span>::<span class="n">default</span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Output</span>::<span class="n">new</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">PB14</span><span class="p">,</span><span class="w"> </span><span class="n">Level</span>::<span class="n">High</span><span class="p">,</span><span class="w"> </span><span class="n">Speed</span>::<span class="n">VeryHigh</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Input</span>::<span class="n">new</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">PC13</span><span class="p">,</span><span class="w"> </span><span class="n">Pull</span>::<span class="n">Up</span><span class="p">);</span>

<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">button</span><span class="p">.</span><span class="n">is_low</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">led</span><span class="p">.</span><span class="n">set_high</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">led</span><span class="p">.</span><span class="n">set_low</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you can see, the application becomes a lot simpler, even without using any async code. The <code class="docutils literal notranslate"><span class="pre">Input</span></code> and <code class="docutils literal notranslate"><span class="pre">Output</span></code> types hide all the details of accessing the GPIO registers and allow you to use a much simpler API for querying the state of the button and toggling the LED output.</p>
<p>The same downside from the PAC example still applies though: the application is busy looping and consuming more power than necessary.</p>
</div>
<div class="section" id="interrupt-driven">
<h2>Interrupt driven<a class="headerlink" href="#interrupt-driven" title="永久链接至标题">#</a></h2>
<p>To save power, we need to configure the application so that it can be notified when the button is pressed using an interrupt.</p>
<p>Once the interrupt is configured, the application can instruct the microcontroller to enter a sleep mode, consuming very little power.</p>
<p>Given Embassy focus on async Rust (which we’ll come back to after this example), the example application must use a combination of the HAL and PAC in order to use interrupts. For this reason, the application also contains some helper functions to access the PAC (not shown below).</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#![no_std]</span>
<span class="cp">#![no_main]</span>

<span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">cell</span>::<span class="n">RefCell</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">cortex_m</span>::<span class="n">interrupt</span>::<span class="n">Mutex</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">cortex_m</span>::<span class="n">peripheral</span>::<span class="n">NVIC</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">cortex_m_rt</span>::<span class="n">entry</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">embassy_stm32</span>::<span class="n">gpio</span>::<span class="p">{</span><span class="n">Input</span><span class="p">,</span><span class="w"> </span><span class="n">Level</span><span class="p">,</span><span class="w"> </span><span class="n">Output</span><span class="p">,</span><span class="w"> </span><span class="n">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">Pull</span><span class="p">,</span><span class="w"> </span><span class="n">Speed</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">embassy_stm32</span>::<span class="n">peripherals</span>::<span class="p">{</span><span class="n">PB14</span><span class="p">,</span><span class="w"> </span><span class="n">PC13</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">embassy_stm32</span>::<span class="p">{</span><span class="n">interrupt</span><span class="p">,</span><span class="w"> </span><span class="n">pac</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="p">{</span><span class="n">defmt_rtt</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">panic_probe</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="n">BUTTON</span>: <span class="nc">Mutex</span><span class="o">&lt;</span><span class="n">RefCell</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">Input</span><span class="o">&lt;&#39;</span><span class="nb">static</span><span class="p">,</span><span class="w"> </span><span class="n">PC13</span><span class="o">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mutex</span>::<span class="n">new</span><span class="p">(</span><span class="n">RefCell</span>::<span class="n">new</span><span class="p">(</span><span class="nb">None</span><span class="p">));</span>
<span class="k">static</span><span class="w"> </span><span class="n">LED</span>: <span class="nc">Mutex</span><span class="o">&lt;</span><span class="n">RefCell</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">Output</span><span class="o">&lt;&#39;</span><span class="nb">static</span><span class="p">,</span><span class="w"> </span><span class="n">PB14</span><span class="o">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mutex</span>::<span class="n">new</span><span class="p">(</span><span class="n">RefCell</span>::<span class="n">new</span><span class="p">(</span><span class="nb">None</span><span class="p">));</span>

<span class="cp">#[entry]</span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">embassy_stm32</span>::<span class="n">init</span><span class="p">(</span><span class="nb">Default</span>::<span class="n">default</span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Output</span>::<span class="n">new</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">PB14</span><span class="p">,</span><span class="w"> </span><span class="n">Level</span>::<span class="n">Low</span><span class="p">,</span><span class="w"> </span><span class="n">Speed</span>::<span class="n">Low</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Input</span>::<span class="n">new</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">PC13</span><span class="p">,</span><span class="w"> </span><span class="n">Pull</span>::<span class="n">Up</span><span class="p">);</span>

<span class="w">    </span><span class="n">cortex_m</span>::<span class="n">interrupt</span>::<span class="n">free</span><span class="p">(</span><span class="o">|</span><span class="n">cs</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">enable_interrupt</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">button</span><span class="p">);</span>

<span class="w">        </span><span class="n">LED</span><span class="p">.</span><span class="n">borrow</span><span class="p">(</span><span class="n">cs</span><span class="p">).</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">replace</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
<span class="w">        </span><span class="n">BUTTON</span><span class="p">.</span><span class="n">borrow</span><span class="p">(</span><span class="n">cs</span><span class="p">).</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">replace</span><span class="p">(</span><span class="n">button</span><span class="p">);</span>

<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">NVIC</span>::<span class="n">unmask</span><span class="p">(</span><span class="n">pac</span>::<span class="n">Interrupt</span>::<span class="n">EXTI15_10</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cortex_m</span>::<span class="n">asm</span>::<span class="n">wfe</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[interrupt]</span>
<span class="k">fn</span> <span class="nf">EXTI15_10</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cortex_m</span>::<span class="n">interrupt</span>::<span class="n">free</span><span class="p">(</span><span class="o">|</span><span class="n">cs</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUTTON</span><span class="p">.</span><span class="n">borrow</span><span class="p">(</span><span class="n">cs</span><span class="p">).</span><span class="n">borrow_mut</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">button</span><span class="p">.</span><span class="n">as_mut</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LED</span><span class="p">.</span><span class="n">borrow</span><span class="p">(</span><span class="n">cs</span><span class="p">).</span><span class="n">borrow_mut</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">led</span><span class="p">.</span><span class="n">as_mut</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">check_interrupt</span><span class="p">(</span><span class="n">button</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">button</span><span class="p">.</span><span class="n">is_low</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">led</span><span class="p">.</span><span class="n">set_high</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">led</span><span class="p">.</span><span class="n">set_low</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">clear_interrupt</span><span class="p">(</span><span class="n">button</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
<span class="c1">//</span>
<span class="c1">//</span>
<span class="c1">//</span>
</pre></div>
</div>
<p>The simple application is now more complex again, primarily because of the need to keep the button and LED states in the global scope where it is accessible by the main application loop, as well as the interrupt handler.</p>
<p>To do that, the types must be guarded by a mutex, and interrupts must be disabled whenever we are accessing this global state to gain access to the peripherals.</p>
<p>Luckily, there is an elegant solution to this problem when using Embassy.</p>
</div>
<div class="section" id="async-version">
<h2>Async version<a class="headerlink" href="#async-version" title="永久链接至标题">#</a></h2>
<p>It’s time to use the Embassy capabilities to its fullest. At the core, Embassy has an async excecutor, or a runtime for async tasks if you will. The executor polls a set of tasks (defined at compile time), and whenever a task <code class="docutils literal notranslate"><span class="pre">blocks</span></code>, the executor will run another task, or put the microcontroller to sleep.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#![no_std]</span>
<span class="cp">#![no_main]</span>
<span class="cp">#![feature(type_alias_impl_trait)]</span>

<span class="k">use</span><span class="w"> </span><span class="n">embassy_executor</span>::<span class="n">Spawner</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">embassy_stm32</span>::<span class="n">exti</span>::<span class="n">ExtiInput</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">embassy_stm32</span>::<span class="n">gpio</span>::<span class="p">{</span><span class="n">Input</span><span class="p">,</span><span class="w"> </span><span class="n">Level</span><span class="p">,</span><span class="w"> </span><span class="n">Output</span><span class="p">,</span><span class="w"> </span><span class="n">Pull</span><span class="p">,</span><span class="w"> </span><span class="n">Speed</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="p">{</span><span class="n">defmt_rtt</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">panic_probe</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">};</span>

<span class="cp">#[embassy_executor::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">(</span><span class="n">_spawner</span>: <span class="nc">Spawner</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">embassy_stm32</span>::<span class="n">init</span><span class="p">(</span><span class="nb">Default</span>::<span class="n">default</span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Output</span>::<span class="n">new</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">PB14</span><span class="p">,</span><span class="w"> </span><span class="n">Level</span>::<span class="n">Low</span><span class="p">,</span><span class="w"> </span><span class="n">Speed</span>::<span class="n">VeryHigh</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExtiInput</span>::<span class="n">new</span><span class="p">(</span><span class="n">Input</span>::<span class="n">new</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">PC13</span><span class="p">,</span><span class="w"> </span><span class="n">Pull</span>::<span class="n">Up</span><span class="p">),</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">EXTI13</span><span class="p">);</span>

<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">button</span><span class="p">.</span><span class="n">wait_for_any_edge</span><span class="p">().</span><span class="k">await</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">button</span><span class="p">.</span><span class="n">is_low</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">led</span><span class="p">.</span><span class="n">set_high</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">led</span><span class="p">.</span><span class="n">set_low</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The async version looks very similar to the HAL version, apart from a few minor details:</p>
<ul class="simple">
<li><p>The main entry point is annotated with a different macro and has an async type signature. This macro creates and starts an Embassy runtime instance and launches the main application task. Using the <code class="docutils literal notranslate"><span class="pre">Spawner</span></code> instance, the application may spawn other tasks.</p></li>
<li><p>The peripheral initialization is done by the main macro, and is handed to the main task.</p></li>
<li><p>Before checking the button state, the application is awaiting a transition in the pin state (low → high or high → low).</p></li>
</ul>
<p>When <code class="docutils literal notranslate"><span class="pre">button.await_for_any_edge().await</span></code> is called, the executor will pause the main task and put the microcontroller in sleep mode, unless there are other tasks that can run. Internally, the Embassy HAL has configured the interrupt handler for the button (in <code class="docutils literal notranslate"><span class="pre">ExtiButton</span></code>), so that whenever an interrupt is raised, the task awaiting the button will be woken up.</p>
<p>The minimal overhead of the executor and the ability to run multiple tasks “concurrently” combined with the enormous simplification of the application, makes <code class="docutils literal notranslate"><span class="pre">async</span></code> a great fit for embedded.</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="永久链接至标题">#</a></h2>
<p>We have seen how the same application can be written at the different abstraction levels in Embassy. First starting out at the PAC level, then using the HAL, then using interrupts, and then using interrupts indirectly using async Rust.</p>
</div>
</div>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../3-Executor/index.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">执行器 Executor</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">在裸机上异步</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, lighk
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            目录
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">From bare metal to async Rust</a><ul>
<li><a class="reference internal" href="#pac-version">PAC version</a></li>
<li><a class="reference internal" href="#hal-version">HAL version</a></li>
<li><a class="reference internal" href="#interrupt-driven">Interrupt driven</a></li>
<li><a class="reference internal" href="#async-version">Async version</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/translations.js"></script>
    </body>
</html>